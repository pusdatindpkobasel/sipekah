<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Form Laporan Harian</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet" />
  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
</head>
<body>
  <div class="container py-4">
    <h4 class="mb-4">Form Laporan Kinerja Harian</h4>
    <div id="formArea"></div>
    <button class="btn btn-primary mt-3" id="btnKembali">Kembali ke Dashboard</button>
  </div>

  <script>
    const SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx/exec';
    let user = JSON.parse(localStorage.getItem('pegawai'));
    const formArea = document.getElementById('formArea');

    if (!user) location.href = 'login.html';

    const hariIni = new Date().toLocaleDateString('en-CA');

    const jam = new Date().getHours();
    const hari = new Date().getDay();
    if (hari === 0 || hari === 6 || jam < 8 || jam > 22) {
      formArea.innerHTML = '<div class="alert alert-warning">Form hanya bisa diakses Senin–Jumat pukul 08.00–22.00</div>';
    } else {
      for (let i = 1; i <= 7; i++) {
        formArea.innerHTML += `
        <div class="card mb-3">
          <div class="card-header">Sesi ${i}</div>
          <div class="card-body">
            <div class="mb-2">
              <label>Uraian Pekerjaan:</label>
              <textarea class="form-control" id="uraian${i}" rows="2"></textarea>
            </div>
            <div class="mb-2">
              <label>Bukti Dukung:</label>
              <input type="file" class="form-control" id="bukti${i}" />
            </div>
            <button class="btn btn-success" onclick="submitSesi(${i})">Kirim Sesi ${i}</button>
          </div>
        </div>`;
      }
    }

    function submitSesi(sesi) {
      const uraian = document.getElementById(`uraian${sesi}`).value.trim();
      const bukti = document.getElementById(`bukti${sesi}`).files[0];
      if (!uraian || !bukti) return Swal.fire('Lengkapi uraian dan bukti dukung!');

      const form = new FormData();
      form.append('action', 'lapor');
      form.append('nip', user.NIP);
      form.append('nama', user.Nama);
      form.append('tanggal', hariIni);
      form.append('sesi', sesi);
      form.append('uraian', uraian);
      form.append('file', bukti);

      fetch(SCRIPT_URL, { method: 'POST', body: form })
        .then(r => r.json())
        .then(res => {
          if (res.status === 'success') {
            Swal.fire('Berhasil', `Sesi ${sesi} berhasil dikirim.`, 'success');
            document.getElementById(`uraian${sesi}`).value = '';
            document.getElementById(`bukti${sesi}`).value = '';
          } else {
            Swal.fire('Gagal', res.message || 'Terjadi kesalahan', 'error');
          }
        })
        .catch(() => Swal.fire('Gagal', 'Tidak dapat menghubungi server.', 'error'));
    }

    document.getElementById('btnKembali').onclick = () => location.href = 'index.html';
  </script>
</body>
</html>
