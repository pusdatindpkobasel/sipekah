<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8">
  <title>Pelaporan Kinerja</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
</head>
<body class="bg-light p-4">
  <div class="container" id="app">
    <h2 class="mb-3">Login Pegawai</h2>
    <div id="loginForm">
      <select id="namaPegawai" class="form-select mb-2"></select>
      <input type="password" id="password" class="form-control mb-2" placeholder="Password">
      <button class="btn btn-primary w-100" onclick="login()">Login</button>
    </div>

    <div id="formLaporan" style="display: none;">
      <div class="alert alert-success" id="infoUser"></div>
      <div id="formSesi"></div>
      <button class="btn btn-success mt-3 w-100" onclick="submitLaporan()">Kirim Laporan</button>
      <button class="btn btn-secondary mt-2 w-100" onclick="logout()">Logout</button>
      <a href="LINK_LOOKER_DASHBOARD" target="_blank" class="btn btn-outline-dark mt-2 w-100">Dashboard</a>
    </div>
  </div>

  <script>
    const URL_GAS = 'https://script.google.com/macros/s/AKfycbyuILYg2W-_P8PhymeRksxOM8XnufOTYXRE4zrr7CSMPDLTD3CzHqG2qAG8txGSyFKxrg/exec';
    const namaPegawaiEl = document.getElementById('namaPegawai');
    const formSesiEl = document.getElementById('formSesi');
    let currentUser = null;

    const namaList = ["-- Pilih Pegawai --", "Nama1", "Nama2", "Nama3"]; // Ganti manual atau fetch

    namaPegawaiEl.innerHTML = namaList.map(n => `<option>${n}</option>`).join('');

    function login() {
      const nama = namaPegawaiEl.value;
      const password = document.getElementById('password').value;
      if (nama === "-- Pilih Pegawai --") return Swal.fire("Pilih nama pegawai!");

      fetch(URL_GAS + "?action=login", {
        method: "POST",
        body: JSON.stringify({ nama, password })
      }).then(r => r.json()).then(res => {
        if (res.success) {
          currentUser = res.data;
          showForm();
        } else {
          Swal.fire(res.message);
        }
      });
    }

    function showForm() {
      document.getElementById('loginForm').style.display = 'none';
      document.getElementById('formLaporan').style.display = 'block';
      document.getElementById('infoUser').innerText = `${currentUser.nama} - ${currentUser.status} - ${currentUser.bidang}`;

      let html = '';
      for (let i = 1; i <= 7; i++) {
        html += `
          <div class="mb-2">
            <label>Sesi ${i}</label>
            <textarea id="sesi${i}" class="form-control mb-1" placeholder="Deskripsi..."></textarea>
            <input type="file" id="bukti${i}" class="form-control">
          </div>`;
      }
      formSesiEl.innerHTML = html;
    }

    async function submitLaporan() {
      const data = {
        nama: currentUser.nama,
        status: currentUser.status,
        bidang: currentUser.bidang
      };

      for (let i = 1; i <= 7; i++) {
        data[`sesi${i}`] = document.getElementById(`sesi${i}`).value;
        const fileInput = document.getElementById(`bukti${i}`);
        if (fileInput.files.length > 0) {
          const file = fileInput.files[0];
          const form = new FormData();
          form.append("file", file);
          form.append("filename", `${currentUser.nama}_sesi${i}_${Date.now()}`);
          const upload = await fetch(URL_GAS + "?action=uploadFile", {
            method: "POST",
            body: form
          }).then(r => r.json());
          data[`bukti${i}`] = upload.url;
        } else {
          data[`bukti${i}`] = "";
        }
      }

      fetch(URL_GAS + "?action=submitLaporan", {
        method: "POST",
        body: JSON.stringify(data)
      }).then(r => r.json()).then(res => {
        if (res.success) {
          Swal.fire("Laporan berhasil dikirim!");
        }
      });
    }

    function logout() {
      location.reload();
    }
  </script>
</body>
</html>
