<!DOCTYPE html>
<html lang="id">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Login SiPeKaH</title>
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet" />
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
<style>
  body, html {
    height: 100%;
    background-color: #f8f9fa;
  }
  .login-container {
    min-height: 100vh;
    display: flex;
    justify-content: center;
    align-items: center;
    padding: 1rem;
  }
  .login-card {
    width: 100%;
    max-width: 400px;
    padding: 2rem;
    box-shadow: 0 0 15px rgba(0,0,0,0.1);
    background-color: white;
    border-radius: 0.5rem;
  }
  .login-header {
    text-align: center;
    margin-bottom: 1.5rem;
  }
  .login-header h1 {
    font-weight: 700;
    margin-bottom: 0.3rem;
  }
  .login-header p {
    color: #6c757d;
    font-size: 1rem;
    margin-bottom: 0;
  }
</style>
</head>
<body>

<div class="login-container">
  <div class="login-card">
    <div class="login-header">
      <h1>SiPeKaH</h1>
      <p>Sistem Pelaporan Kinerja Harian Pegawai</p>
    </div>
    <form id="login-form" class="d-flex flex-column gap-3" novalidate>
      <select id="nama" class="form-select" required>
        <option value="" disabled selected>Pilih Nama</option>
      </select>
      <input type="password" id="pin" class="form-control" placeholder="PIN" required />
      <button type="submit" class="btn btn-primary">Login</button>
    </form>
  </div>
</div>

<script>
const WEB_APP_URL = 'https://script.google.com/macros/s/AKfycbxS9glVdvcS0yfMOeEdYxiTgjLbwc2F_TRwoxGG1dYh_3cAPqzFWnHUOOiLSdFgMZR3rA/exec';

let pegawaiList = [];

// JSONP callback untuk load data pegawai
function handlePegawai(data) {
  pegawaiList = data;
  const select = document.getElementById('nama');
  data.forEach(p => {
    const opt = document.createElement('option');
    opt.value = p[0];
    opt.textContent = p[0];
    select.appendChild(opt);
  });
}

// Load data pegawai via JSONP
(function loadPegawai(){
  const script = document.createElement('script');
  script.src = `${WEB_APP_URL}?action=getPegawai&callback=handlePegawai`;
  script.onerror = () => Swal.fire('Error', 'Gagal memuat data pegawai', 'error');
  document.body.appendChild(script);
})();

// Login form submit handler
document.getElementById('login-form').addEventListener('submit', e => {
  e.preventDefault();
  const nama = document.getElementById('nama').value;
  const pin = document.getElementById('pin').value;
  const data = pegawaiList.find(p => p[0] === nama);

  if (!data || pin !== data[7]) {
    Swal.fire('Gagal', 'PIN salah', 'error');
    return;
  }

  Swal.fire({
    title: 'Memuat data...',
    allowOutsideClick: false,
    didOpen: () => {
      Swal.showLoading();
    }
  });

  const userData = {
    nama: data[0],
    nip: data[2],
    subbid: data[3],
    status: data[4],
    golongan: data[5],
    jabatan: data[6]
  };

  localStorage.setItem('userData', JSON.stringify(userData));
  localStorage.setItem('loginTime', new Date().toISOString());

  setTimeout(() => {
    Swal.close();
    window.location.href = 'index.html';
  }, 1000); // simulasi loading
});
</script>

</body>
</html>
